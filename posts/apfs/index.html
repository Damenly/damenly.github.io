<!doctype html><html lang=en data-mode=light>
<head prefix="og: http://ogp.me/ns#">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.89.4">
<meta name=theme content="Color Your World -- gitlab.com/rmaguiar/hugo-theme-color-your-world">
<title>apfs</title>
<meta name=robots content="index follow">
<link rel=canonical href=http://damenly.github.io/posts/apfs/>
<meta property="og:site_name" content="D">
<meta property="og:title" content="apfs">
<meta property="og:url" content="http://damenly.github.io/posts/apfs/">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-06-22">
<meta property="article:modified_time" content="2021-06-22">
<meta property="og:updated_time" content="2021-06-22">
<meta name=theme-color content="#222">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="default">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebSite","@id":"http:\/\/damenly.github.io\/"},"headline":"apfs","description":"","url":"http:\/\/damenly.github.io\/posts\/apfs\/","inLanguage":"en","datePublished":"2021-06-22","dateModified":"2021-06-22","wordCount":"531","publisher":{"@type":"Person","name":""},"author":{"@type":"Person","name":""}}</script>
<link rel=stylesheet href=http://damenly.github.io/css/main.min.bfaec3ddc00f7782895efb66387bdb4416a3cddbb38955597771de3b7307c0ef.css integrity="sha256-v67D3cAPd4KJXvtmOHvbRBajzduziVVZd3HeO3MHwO8=" crossorigin=anonymous>
<noscript>
<meta name=theme-color content="#1dbc91" media="(prefers-color-scheme: dark)">
<meta name=theme-color content="#1f676b" media="(prefers-color-scheme: light)">
<link rel=stylesheet href=http://damenly.github.io/css/noscript.min.9bacd85b6f1d42296c56d3b8457d0c13a4e7f415c4ca5fc8affb6ed6b39cad72.css integrity="sha256-m6zYW28dQilsVtO4RX0ME6Tn9BXEyl/Ir/tu1rOcrXI=" crossorigin=anonymous>
</noscript>
<link rel=preload href=/fonts/open-sans-v17-latin-700.woff2 as=font crossorigin=anonymous>
<link rel=preload href=/fonts/open-sans-v17-latin-italic.woff2 as=font crossorigin=anonymous>
<link rel=preload href=/fonts/open-sans-v17-latin-regular.woff2 as=font crossorigin=anonymous>
<link rel=preload href=/fonts/oswald-v29-latin-700.woff2 as=font crossorigin=anonymous>
<script src=http://damenly.github.io/js/main.min.dd78ee91e8ad16d9570adefe0fb4135123f73a1fe7c44b04771ad23909893d00.js integrity="sha256-3XjukeitFtlXCt7+D7QTUSP3Oh/nxEsEdxrSOQmJPQA=" crossorigin=anonymous></script>
</head>
<body>
<header>
<a href=/>D</a>
<nav aria-label="Main menu.">
<ul>
<li>
<a class=btn href=https://damenly.github.io/posts/about_me>About ME</a>
</li>
<li>
<a class=btn href=https://damenly.github.io/posts/apfs>APFS</a>
</li>
<li>
<a class=btn href=/index.html>index</a>
</li>
<li>
<a class=btn href=https://blog.damenly.su/posts/wb2twitter>wb2twitter</a>
</li>
</ul>
</nav>
</header>
<div class=filler>
<main>
<article>
<header>
<h1>apfs</h1>
<p>
Published on <time datetime=2021-06-22>2021-06-22</time>
</p>
</header>
<h1 id=apfs-notes>APFS NOTES</h1>
<p>This blog just records something when I port apfs(Apple file system) to Linux.
Please forgive my english ;)</p>
<h2 id=apfs-maximum-subvolume-limit><a class=anchor href=#apfs-maximum-subvolume-limit title="Anchor for: APFS maximum subvolume limit."><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a> APFS maximum subvolume limit</h2>
<p>A complete APFS consists of one container super block (nx_superblcok) and multi
subvolumes. Each subvolume has its own superblock, fs tree, backref tree.
And Thanks to Apple&rsquo;s good design, the maximum subvolume numer of one APFS is
100. It&rsquo;s defined in struct apfs_nx_superblock:</p>
<pre aria-label="Box containing code sample." tabindex=0><code>#define APFS_MAX_FILE_SYSTEMS 100

struct apfs_nx_superblock {
        ...
        /* This value must not be larger than the value of APFS_MAX_FILE_SYSTTEM */
        __le32 max_file_systems;
    
        __le64 fs_oid[APFS_MAX_FILE_SYSTEMS];
        ...
};
</code></pre><p>I have tried to create the 101th subvolume in macos, it failed as expected.
Unlike btrfs which treats snapshots as subvolumes, apfs create snapshot related
infomation inside subvolume. It means we can create snapshots of a subvolume
as much as we want. However, the trade cost is only one snapshot/subvolume per
apfs_vol_superblock being mounted meantime.</p>
<h2 id=apfs-superblock-and-its-csum><a class=anchor href=#apfs-superblock-and-its-csum title="Anchor for: APFS superblock and its csum."><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a> APFS superblock and its csum</h2>
<p>Superblocks structures are:</p>
<pre aria-label="Box containing code sample." tabindex=0><code>#define APFS_SUPER_INFO_SIZE 4096

struct apfs_nx_superblock {
        struct apfs_obj_header o;
        __le32 magic; // must be APFS_MAGIC
        
        __le32 block_size;
        __le64 block_count;
        __le64 features;
        __le64 readonly_compatible_features;
        __le64 incompatible_features;
        ...
};

/* Volume superblock */
struct apfs_vol_superblock {
        struct apfs_obj_header o;
        __le32 magic; /* Must be 'BSPA' */
        
        __le32 fs_index;

        __le64 features;
        __le64 readonly_compat_features;
        __le64 incompat_features;
        __le64 unmount_time;
        __le64 reserved;
        __le64 quota;
        __le64 allocated;
        struct apfs_wrapped_meta_crypto_state meta_crypto;
        ...
};
</code></pre><p>In APFS, every tree node, container and subvolume superblocks have their
obj_header members. Btrfs has similar designs for tree nodes and file extents.
Because apfs seems don&rsquo;t CoW its tree node, every object item has its csum field
in obj header.</p>
<p>Object header structure:</p>
<pre aria-label="Box containing code sample." tabindex=0><code>/* Header of all objects */
struct apfs_obj_header {
        u8 csum[APFS_CSUM_SIZE];
        __le64 oid;
        __le64 xid;
        /*
         * The low 16 bits value means object type.
         * The high 16 bits are mixed flags.
         */
        __le32 type;
        __le32 subtype;
};
</code></pre><p>And APFS generates csum using fletcher64:</p>
<pre aria-label="Box containing code sample." tabindex=0><code>/*
 * Note that this is not a generic implementation of fletcher64, as it assumes
 * a message length that doesn't overflow sum1 and sum2.  This constraint is ok
 * for apfs, though, since the block size is limited to 2^16.  For a more
 * generic optimized implementation, see Nakassis (1988).
 */
static u64 apfs_fletcher64(const void *addr, size_t len)
{
        const __le32 *buff = addr;
        u64 sum1 = 0;
        u64 sum2 = 0;
        u64 c1, c2;
        int i;

        for (i = 0; i &lt; len / sizeof(u32); i++) {
                sum1 += le32_to_cpu(buff[i]);
                sum2 += sum1;
        }

        c1 = sum1 + sum2;
        c1 = 0xFFFFFFFF - c1 % (u64)0xFFFFFFFF;
        c2 = sum1 + c1;
        c2 = 0xFFFFFFFF - c2 % (u64)0xFFFFFFFF;

        return (c2 &lt;&lt; 32) | c1;
}
</code></pre><p>@addr in APFS should be address of @apfs_obj_header and len should
be (node_size - APFS_CSUMS_SIZE) or (APFS_SUPER_INFO_SIZE - APFS_CSUMS_SIZE).</p>
<h2 id=apfs-cow><a class=anchor href=#apfs-cow title="Anchor for: APFS COW."><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a> APFS COW</h2>
<p>Unlike btrfs, nowdays xfs has data COW ability but no metadata COW.</p>
<div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden>
<iframe src=https://www.youtube.com/embed/wG8FUvSGROw style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe>
</div>
<p>After dumping APFS data structures, I realized APFS, like xfs does not do
metadata COW but data COW only. There are data&rsquo;s extent backrefs in every
subvolume but no metadata&rsquo;s.
And one more thing shocked me: apfs does metadata checksum indeed but no checksum
of data at all????!!!! Mabye it&rsquo;s Apple&rsquo;s dignity in protecting user data :)</p>
<h2 id=credits><a class=anchor href=#credits title="Anchor for: Credits:."><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a> Credits:</h2>
<ul>
<li><a href=https://github.com/linux-apfs/linux-apfs-rw/>https://github.com/linux-apfs/linux-apfs-rw/</a></li>
<li><a href=https://github.com/sgan81/apfs-fuse/>https://github.com/sgan81/apfs-fuse/</a></li>
<li><a href=https://developer.apple.com/support/downloads/Apple-File-System-Reference.pdf>https://developer.apple.com/support/downloads/Apple-File-System-Reference.pdf</a></li>
</ul>
</article>
</main>
</div>
<footer>
<section class=req-js>
<button class=outline-dashed title="Change to light/dark mode."><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><use xlink:href="#adjust"/></svg></button><input class=outline-dashed type=color list=presets value=#1f676b title="Change accent color." aria-label="Change accent color."><datalist id=presets><option value=#1f676b><option value=#1dbc91></datalist>
</section>
</footer><svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" aria-hidden="true"><symbol viewBox="0 0 512 512" id="adjust"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></symbol><symbol viewBox="0 0 448 512" id="hashtag"><path d="M440.667 182.109l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l14.623-81.891C377.123 38.754 371.468 32 363.997 32h-40.632a12 12 0 00-11.813 9.891L296.175 128H197.54l14.623-81.891C213.477 38.754 207.822 32 200.35 32h-40.632a12 12 0 00-11.813 9.891L132.528 128H53.432a12 12 0 00-11.813 9.891l-7.143 40C33.163 185.246 38.818 192 46.289 192h74.81L98.242 320H19.146a12 12 0 00-11.813 9.891l-7.143 40C-1.123 377.246 4.532 384 12.003 384h74.81L72.19 465.891C70.877 473.246 76.532 480 84.003 480h40.632a12 12 0 0011.813-9.891L151.826 384h98.634l-14.623 81.891C234.523 473.246 240.178 480 247.65 480h40.632a12 12 0 0011.813-9.891L315.472 384h79.096a12 12 0 0011.813-9.891l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l22.857-128h79.096a12 12 0 0011.813-9.891zM261.889 320h-98.634l22.857-128h98.634l-22.857 128z"/></symbol></svg>
</body>
</html>